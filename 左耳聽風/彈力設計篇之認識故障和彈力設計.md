# 彈力設計篇之認識故障和彈力設計

**容錯設計又叫彈力設計**，其中著眼於分布式系統的各種容忍能力，包括容錯能力（服務隔離、異步調用、請求冪等性）、可伸縮性（有 / 無狀態的服務）、一致性（補償事務、重試）、應對大流量的能力（熔斷、降級）。在確保系統正確性的前提下，系統的可用性是容錯設計保障的重點。

## 系統可用性測量

對於分布式系統的容錯設計，在英文中又叫 Resiliency（彈力）。意指系統在不健康，甚至出錯的情況下有能力 hold 得住。

容錯主要是為了可用性，下面為業界可用性計算公式：
```math
Availability = MTTF/ MTTF +
MTTR
```
* MTTF 是 **Mean Time To Failure**，平均故障前的时间，即系统平均能够正常运行多长时间才发生一次故障。系统的可靠性越高，MTTF 越长。（注意：从字面上来说，看上去有 Failure 的字样，但其实是正常运行的时间。）
* MTTR 是 **Mean Time To Recovery**，平均修复时间，即从故障出现到故障修复的这段时间，这段时间越短越好。

常說的幾個9，為計算系統可用性，如下圖：
![](media/16823462140440/16823466661738.jpg)

## 故障原因

故障因素太多，簡單看就是 SLA 的幾個 9 就是能持續提供可用服務的級別。不過，工業界中，會把服務不可用的因素分成兩種：一種是有計劃的，一種是無計劃的。

無計劃的當機原因。下圖來自 Oracle 的 High Availability Concepts and Best Practices：

![](media/16823462140440/16823468963340.jpg)
有計劃的當機原因。下圖來自 Oracle 的High Availability Concepts and Best Practices：

![](media/16823462140440/16823469457438.jpg)
再歸納分類
1. 網絡問題。網絡鏈接出現問題，網絡帶寬出現擁塞……
2. 性能問題。數據庫慢 SQL、Java Full GC、硬盤 IO 過大、CPU 飆高、內存不足……
3. 安全問題。被網絡攻擊，如 DDoS 等。
4. 運維問題。系統總是在被更新和修改，架構也在不斷地被調整，監控問題……
5. 管理問題。沒有梳理出關鍵服務以及服務的依賴關係，運行信息沒有和控制系統同步……
6. 硬件問題。硬盤損壞、網卡出問題、交換機出問題、機房掉電、挖掘機問題……

## 故障不可避免

分布式故障涉及很多層面，因此非常複雜。

![](media/16823462140440/16823472754395.jpg)
需要留意兩件事：
* **故障是正常的，而且是常見的。**
* **故障是不可預測突發的，而且相當難纏。**

**不要尝试着去避免故障，而是要把处理故障的代码当成正常的功能做在架构里写在代码里**。因為我們要乾的事兒就是想盡一切手段來**降低 MTTR 故障的修復時間**。

## 小結

結合上述討論，這個設計為彈力（Resiliency）原因為
* 一方面，在好的情況下，這個事對於我們的用戶和內部運維來說是完全透明的，系統自動修復不需要人的干預。
* 另一方面，如果修復不了，系統能夠做自我保護，而不讓事態變糟糕。


文章 4 月 Day24 學習筆記，內容來源於極客時間 [《左耳聽風》](http://gk.link/a/122pq)
