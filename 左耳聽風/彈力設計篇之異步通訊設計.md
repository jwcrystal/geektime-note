# 彈力設計篇之異步通訊設計

| 特點 | 同步調用 | 異步調用 |
| --- | --- | --- |
| 調用方等待時間 | 調用方需要一直等待被調用方完成才能繼續執行 | 調用方不需要等待被調用方完成，可以繼續執行其他任務 |
| 性能影響 | 整個同步調用鏈的性能會由最慢的那個服務所決定 | 異步調用不會影響整個調用鏈的性能，每個服務的性能獨立計算 |
| 併發處理 | 同步調用只能是一對一的，很難做到一對多 | 異步調用可以實現一對多、多對一、多對多等併發處理 |
| 資源消耗 | 同步調用會消耗調用方的資源，需要保存現場等待遠端返回 | 異步調用不需要保存現場，不會消耗調用方的資源 |
| 容錯性 | 同步調用如果被調用方有問題，調用方也會出現問題，容錯性較差 | 異步調用可以通過消息隊列等機制實現重試、容錯等功能，容錯性較好 |
| 適用場景 | 適用於簡單場景、請求量不大、併發量不高的情況 | 適用於複雜場景、請求量大、併發量高的情況 |


## 異步通訊的三種方式
### 請求響應式

會出現耦合情況，發送方依賴於接收方，並且要把自己的回調發送給接收方，處理完後回調。 

對於返回結果，有兩種方法處理：
- 一種是發送方時不時地去輪詢一下。
- 另一種是發送方註冊一個回調方法，也就是接收方處理完後回調請求方。

### 通過訂閱的方式

接收方（receiver）會來訂閱發送方（sender）的消息，發送方會把相關的消息或數據放到接收方所訂閱的隊列中，而接收方會從隊列中獲取數據。

接收方需要向發送方訂閱事件，所以是接收方依賴於發送方。這種方式還是有一定的耦合。

### 通過 Broker 的方式

所謂 Broker，就是一個中間人，發送方（sender）和接收方（receiver）都互相看不到對方，它們看得到的是一個 Broker，發送方向 Broker 發送消息，接收方向 Broker 訂閱消息。如下圖所示。

![](media/16824878358655/16825201716331.jpg)

完全解耦。所有服務都不會互相依賴，而是依賴 Broker 中間件。但要留意的是，這個中間件需要有下面特性：

* 必須是高可用的，因為它成了整個系統的關鍵。
* 必須是高性能而且是可以水平擴展的。
* 必須是可以持久化不丟數據的。

## 事件驅動設計

上述的第二種和第三種方式就是比較著名的**事件驅動架構（EDA – Event Driven Architecture）**。正如前面所說，事件驅動最好是使用 Broker 方式，服務間通過交換消息來完成交流和整個流程的驅動。

事件驅動有以下好處：

* 服務間沒有相依性，每個服務都是高度可重用並可被替換的。
* 服務的開發、測試、運維，以及故障處理都是高度隔離的。
* 服務間通過事件關聯，所以服務間是不會相互 block 的。
* 在服務間增加一些 Adapter（如日誌、認證、版本、限流、降級、熔斷等）相當容易。
* 服務間的吞吐也不會被限制，各個服務可以按照自己的處理速度處理。

## 異步通訊的設計重點

為什麼需要異步通訊？

* **異步通訊最重要的是解耦服務間的依賴。最佳解耦的方式是通過 Broker 的機制**。
* 解耦的目的是讓各個服務的隔離性更好，這樣不會出現一倒倒一片的故障。
* 異步通訊的架構可以獲得更大的吞吐量，而且各個服務間的性能不受干擾相對獨立。
* 利用 Broker 或隊列的方式還可以達到把抖動的吞吐量變成均勻的吞吐量，這就是所謂的**削峰**，這對後端系統是個不錯的保護。
* 服務相對獨立，在部署、擴容和運維上都可以做到獨立不受其他服務的干擾。

有好處也有壞處，需要注意下面幾點：

* 用於異步通訊的中間件 Broker 成為了關鍵，需要設計成高可用不丟消息的。另外，**因為是分布式的，所以可能很難保證消息的順序，因此設計最好不依賴於消息的順序。**
* **異步通訊會導致業務處理流程不那麼直觀**，因為像接力一樣，所以在 Broker 上**需要有相關的服務消息跟蹤機制**，否則出現問題後不容易調試。
* 因為服務間只通過消息交互，所以業務狀態最好由一個總控方來管理，這個總控方維護一個業務流程的狀態變遷邏輯，以便系統發生故障後知道業務處理到了哪一步，從而可以在故障清除後繼續處理。

文章 4 月 Day26 學習筆記，內容來源於極客時間 [《左耳聽風》](https://time.geekbang.org/column/article/3926)
