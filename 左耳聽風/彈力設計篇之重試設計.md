# 彈力設計篇之重試設計

在軟體設計中,添加適當的重試機制非常重要。它可以:

1. 提高系統的可用性和故障恢復能力。即使部分組成失敗,整體服務能繼續正常運作。

2. 充分利用暫時性故障,避免由於一次性故障導致服務長時間停止。許多故障都是暫時性的,進行重試就可能恢復正常。

3. 避免死結點。如果沒有重試機制,一些操作由於故障而產生死結,整個服務將無法恢復運作。重試可以避免這種情形。

## 重試方法設計

主要有幾種設計重試機制的方法:

1. 初始延遲重試:第一次重試的延遲時間較長,以便於暫時性故障自行修復。之後延遲時間逐漸縮短。

2. 指數退避:每次重試延遲時間以指定指數增加。第一次重試後延遲1秒,第二次重試後延遲2秒,第三次重試後延遲4秒,以此類推。這可以較多重試避免重複操作。

3. 限制重試次數:設定最大允許的重試次數。超過次數限制後返回錯誤,避免服務過多時間在無用操作上。

4. 組合重試:同時進行多種重試策略。例如,第1秒、3秒、7秒重試,以後每次重試延遲以2倍速增加,限制10次。 

5. 隨機重試:在指定範圍內產生隨機延遲,以增加不同重試間隔,減少重複操作的可能性。 

其他一些常用方法尚有:每次重試後隨機選擇重新配置資源;設定最大理論重試次數但每次實際重試時間隨機;在指定數量重試後重新初始化系統等。

## 重試設計的重點

設計重試機制的重點有:

1. 分析服務故障及其影響。理解不同故障類型對服務的影響程度和持續時間,以確定重試策略。例如頻繁出現暫時性故障還是長時間低頻故障對策略有重大影響。

2. 設定合理重試次數和延遲時間限制。選擇適度的延遲可以避免快速重試導致資源耗竭,但又要確保在短時間內恢復正常工作。設計上限可避免服務長時間困在循環重試中。

3. 考慮不同重試策略的組合使用。不同策略在不同場景下效果不同, 組合使用可以獲得更高的彈性及故障容量。例如先使用固定延遲,超過次數限制後用指數退避。

4. 考慮重試過程中資源使用及回收。在延遲期間進行資源回收操作可以避免資源過度使用導致系統性能下降。但也要避免在即將恢復工作時資源又被全部回收。需要在具體系統下進行安排。

5. 設計對不同故障情形的執行方案。對於預期在重試過程中可恢復工作的故障,設計恢復策略;對於非暫時性故障,設計提前結束重試的條件和將工作轉移至其他服務或地點的機制。

6. 在實際開發過程中進行調整。即使設計理想,在沙盒或生產環境下運行後,重試設定可能仍需要調整以適應實際工作負荷與故障特性。通過不斷測試得到最佳設計結果非常重要。

文章 4 月 Day30 學習筆記，內容來源於極客時間 [《左耳聽風》](http://gk.link/a/122Hs)
