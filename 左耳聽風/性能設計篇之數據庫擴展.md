# 性能設計篇之數據庫擴展

## 讀寫分離

數據庫讀寫分離是一種常用的數據庫優化技術，它將數據庫的讀寫操作分離到不同的服務器上，以提高應用程序的性能和可擴展性。具體而言，當應用程序需要讀取數據時，它可以從只讀數據庫服務器上讀取數據，而當它需要寫入數據時，則需要連接到主數據庫服務器。

數據庫讀寫分離的優點主要包括以下幾個方面：

1. 提高性能：通過將讀操作和寫操作分離到不同的服務器上，可以減輕主數據庫服務器的負載，從而提高應用程序的讀取性能。

2. 提高可擴展性：通過向只讀數據庫服務器添加更多服務器，可以輕鬆地擴展讀取容量，而不會對主數據庫服務器造成太大的壓力。

3. 提高可靠性：如果主數據庫服務器故障，只讀數據庫服務器仍然可以繼續提供數據讀取服務，從而提高應用程序的可靠性。

4. 提高安全性：只讀數據庫服務器只能執行讀取操作，因此可以更容易地對其進行安全配置。

缺點是：
* 主數據庫（寫庫）有單點故障問題。如果是寫庫出了性能問題，那麼所有的業務一樣不可用。
* 數據庫同步不實時，需要強一致性的讀寫操作還是需要落在主數據庫（寫庫）上。

實現數據庫讀寫分離通常需要進行以下步驟：

1. 配置主數據庫服務器：主數據庫服務器用於處理寫操作和讀取操作。

2. 配置只讀數據庫服務器：只讀數據庫服務器用於處理讀取操作。必須確保只讀數據庫服務器與主數據庫服務器保持同步，以便提供最新的數據。

3. 配置負載均衡器：負載均衡器用於將應用程序的讀取請求分配到只讀數據庫服務器上，而將寫請求分配到主數據庫服務器上。


## 讀寫分離 CQRS

讀寫分離 (CQRS，Command Query Responsibility Segregation) 是一種架構模式，用於將應用程序中的讀操作和寫操作分開處理。**CQRS 的核心思想是將讀和寫操作分別分配到不同的模型中，以便優化應用程序的性能和可擴展性**。

在傳統的 CRUD (Create, Read, Update, Delete) 應用程序中，讀操作和寫操作通常被視為同等重要。但實際上，讀操作的頻率往往比寫操作高得多，因此將讀和寫操作分開處理可以優化應用程序的性能和可擴展性。

CQRS 模式的核心是將應用程序的命令（Commands）和查詢（Queries）分開處理。命令是指修改數據的操作，例如創建、更新或刪除數據。查詢是指獲取數據的操作，例如讀取數據或計算統計信息。通過將命令和查詢分開處理，可以使應用程序更容易擴展和優化。

**在 CQRS 模式中，通常會使用兩個不同的模型來處理命令和查詢**。命令模型通常是一個簡單的 CRUD 模型，用於處理修改數據的操作。查詢模型則通常是一個專門用於查詢數據的模型，它可以根據查詢的類型和需求進行優化。例如，可以使用緩存來提高查詢性能，或者使用專門的數據結構來支持高效的統計計算。

兩種操作可以在語義上做區分：

* 命令 Command 不會返回結果數據，只會返回執行狀態，但會改變數據。
* 查詢 Query 會返回結果數據，但是不會改變數據，對系統沒有副作用。

如果**把 Command 操作變成 Event Sourcing**，那麼只需要記錄不可修改的事件，並通過回溯事件得到數據的狀態。我們可以**把寫操作給完全簡化掉，也變成無狀態的，這樣可以大幅度降低整個系統的副作用**，並可以得到更大的併發和性能。

CQRS and Event Sourcing Application with Cassandra
![](https://static001.geekbang.org/resource/image/ce/87/ceeb536d0fa15afa4f5fde0b2cbe7787.png?wh=831*339)

下面表格比較讀寫分離 CQRS 和數據庫讀寫分離的主要特點：

| 特點 | 讀寫分離 CQRS | 數據庫讀寫分離 |
| --- | --- | --- |
| 定義 | 將應用程序的讀操作和寫操作分開處理 | 將數據庫的讀操作和寫操作分離到不同的服務器上 |
| 優點 | 提高應用程序的性能和可擴展性 | 提高應用程序的性能、可擴展性、可靠性和安全性 |
| 操作 | 使用不同的模型來處理命令和查詢 | 配置主數據庫服務器、只讀數據庫服務器和負載均衡器 |
| 主要目的 | 優化應用程序的性能和可擴展性 | 減輕主數據庫服務器的負載，提高應用程序的讀取性能 |
| 實現方式 | 將命令和查詢分離處理，並使用不同的模型來處理它們 | 配置主數據庫服務器、只讀數據庫服務器和負載均衡器 |
| 適用場景 | 高併發的應用程序，讀操作頻繁 | 高併發的應用程序，讀操作頻繁，寫操作相對較少 |
 
## 分庫分表 Sharding

分庫分表 (Sharding) 是一種在關係型數據庫中實現水平擴展的技術，它將數據分散到多個數據庫中，以提高應用程序的性能和可擴展性。

具體而言，分庫分表技術將數據按照某種規則分散到多個數據庫中，每個數據庫只存儲部分數據。例如，可以按照用戶 ID 或時間戳等規則將數據分散到不同的數據庫中。在查詢數據時，應用程序需要查詢所有數據庫中的數據，並將結果進行合併。

實現分庫分表通常需要進行以下步驟：

1. **設計分片鍵**：分片鍵是用於將數據分散到多個數據庫中的規則，例如用戶 ID 或時間戳等。

2. 配置分片路由：分片路由用於確定應用程序需要查詢哪些數據庫。

3. 配置數據庫集群：數據庫集群由多個數據庫服務器組成，每個服務器都存儲部分數據。

> 選擇合適的分片鍵是分庫分表實現成功的關鍵之一。應該選擇具有高離散度、查詢效率高、數據增長趨勢穩定、可擴展性好的字段作為分片鍵，根據應用場景和數據特點進行權衡和選擇。

為了避免數據訪問層的麻煩，分片策略一般如下：

* **按多租戶的方式**。用租戶 ID 來分，這樣可以把租戶隔離開來。比如：一個電商平台的商家中心可以按商家的 ID 來分。
* **按數據的種類來分**。比如，一個電商平台的商品庫可以按類目來分，或是商家按地域來分。
* **通過範圍來分**。這樣分片，可以保證在同一分片中的數據是連續的，於是我們數據庫操作，比如分頁查詢會更高效一些。一般來說，大多數情況是用時間來分片的，比如，一個電商平台的訂單中心是按月份來分表的，這樣可以快速檢索和統計一段連續的數據。
* **通過哈希散列算法來分**（比如：主鍵 id % 3 之類的算法。）此策略的**目的是降低形成熱點的可能性**（接收不成比例的負載的分片）。但是，這會帶來兩個問題，一個就是前面所說的跨庫跨表的查詢和事務問題，另一個就是如果要擴容需要重新哈希部分或全部數據。
> 需要注意關鍵事宜：
> 1. 數據庫分片必須考慮業務，從業務的角度入手，而不是從技術的角度入手，如果不清楚業務，那麼無法做出好的分片策略。
> 2. 請只考慮業務分片。不是最後一步別走哈希散列的分片方式。

## 數據庫擴展設計重點

數據庫擴展的設計重點包括以下幾個方面：

1. 數據庫架構設計：在數據庫設計時需要考慮擴展性，採用可擴展的架構設計，例如分布式數據庫架構、主從複製架構和讀寫分離架構等。

2. 分片策略設計：為了支持水平擴展，需要設計合適的分片策略，將數據分散到多個分片中，以實現更好的性能和可擴展性。

3. 集群管理與監控：為了保證數據庫的穩定性和高可用性，需要設計合適的集群管理和監控機制，例如自動故障切換、負載均衡和實時監控等。

4. 數據備份和恢復：為了保證數據的安全性和可靠性，需要設計合適的數據備份和恢復機制，例如定期備份和增量備份等。

5. 性能優化：為了提高數據庫的性能，需要進行合適的性能優化，例如索引優化、查詢優化和緩存優化等。

6. 安全性設計：為了保證數據庫的安全性，需要設計合適的安全性措施，例如訪問控制、數據加密和漏洞修補等。

文章 5 月 Day13 學習筆記，內容來源於極客時間 [《左耳聽風》](http://gk.link/a/123iv)
